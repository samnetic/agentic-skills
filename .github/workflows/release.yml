name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify release metadata
        run: bash scripts/verify-release-metadata.sh "${GITHUB_REF_NAME}"

      - name: Shell syntax checks
        run: |
          bash -n install.sh uninstall.sh agentic-skills.sh
          bash -n tests/smoke-installer.sh tests/smoke-manager.sh tests/run-all.sh
          bash -n scripts/render-homebrew-formula.sh scripts/verify-release-metadata.sh

      - name: Installer smoke tests
        run: bash tests/smoke-installer.sh

      - name: Manager smoke tests
        run: bash tests/smoke-manager.sh

      - name: npm package dry-run
        run: |
          TMP_NPM_CACHE="$(mktemp -d)"
          npm --cache "$TMP_NPM_CACHE" pack --dry-run
          rm -rf "$TMP_NPM_CACHE"

  github_release:
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
    steps:
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

  publish_npm:
    runs-on: ubuntu-latest
    needs:
      - validate
      - github_release
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Ensure npm token exists
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ -z "${NODE_AUTH_TOKEN:-}" ]]; then
            echo "NPM_TOKEN secret is required for release publishing." >&2
            exit 1
          fi

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --provenance

  update_homebrew_formula:
    runs-on: ubuntu-latest
    needs:
      - validate
      - publish_npm
    permissions:
      contents: read
    env:
      HOMEBREW_TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
      HOMEBREW_TAP_BRANCH: ${{ vars.HOMEBREW_TAP_BRANCH }}
      HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Homebrew tap formula
        run: |
          set -euo pipefail

          if [[ -z "${HOMEBREW_TAP_GITHUB_TOKEN:-}" ]]; then
            echo "HOMEBREW_TAP_GITHUB_TOKEN is not set; skipping Homebrew formula update."
            exit 0
          fi

          VERSION="${GITHUB_REF_NAME#v}"
          TAR_URL="https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz"
          TAR_PATH="/tmp/agentic-skills-${VERSION}.tar.gz"
          TAP_REPO="${HOMEBREW_TAP_REPO:-samnetic/homebrew-agentic-skills}"
          TAP_BRANCH="${HOMEBREW_TAP_BRANCH:-main}"
          TAP_DIR="/tmp/homebrew-agentic-skills-tap"

          curl -fsSL "$TAR_URL" -o "$TAR_PATH"
          SHA256="$(sha256sum "$TAR_PATH" | awk '{print $1}')"

          git clone "https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/${TAP_REPO}.git" "$TAP_DIR"
          bash scripts/render-homebrew-formula.sh "$VERSION" "$SHA256" "$TAP_DIR/Formula/agentic-skills.rb"

          cd "$TAP_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- Formula/agentic-skills.rb; then
            echo "Formula already up-to-date."
            exit 0
          fi

          git add Formula/agentic-skills.rb
          git commit -m "agentic-skills ${VERSION}"
          git push origin "HEAD:${TAP_BRANCH}"
